#! /bin/bash
old_rev="none"
#old_rev=`git log -1 --pretty="%H"`
#echo $old_rev
thisdir="$(basename "$(pwd)")"

while [ 1 ]; do
    new_rev=`git ls-remote "$(git config --get remote.origin.url)" HEAD | cut -f 1`
    if [ $new_rev != $old_rev ]; then
        old_rev=$new_rev
        git fetch --all
        git reset --hard origin/master
        docker build -t $thisdir .
        docker stop my_$thisdir
        docker rm my_$thisdir
        docker run -d -p 1880:1880 -e NRKEY=$ANARCHY --name my_$thisdir $thisdir
        echo $old_rev
    fi
    sleep 60
done
